extends layout

block content
    div#container
        div#roomEntry Room ID
            form#roomForm(name="join-room")
                input#playerRoomField(type="text", name="room-id" autofocus autocomplete="off")
                input#roomSubmit(type="submit", value="GO")
        div#curtain
        div#message
        div#username
    script(src='js/jquery-1.6.2.js')
    script(src='js/faker.js')
    script(src='/socket.io/socket.io.js')
    script(src='js/fastclick.js')
    script.
        $(function () {

            FastClick.attach(document.body);

            // Initialize variables
            var $window = $(window);
            var $actionPage = $('.action-page'); // The actionroom page

            // Socket Vars
            var socket = io();
            var connected;

            // Curtain Setup
            var $curtain = $('#curtain');
            var $message = $('#message');
            var $username = $('#username');

            // Automatically set username
            var username = faker.name.firstName() + ' ' + faker.name.lastName();
            $username.html(username);

            // Room Entry
            $roomEntry = $('#roomEntry');
            $roomForm = $('#roomForm');
            $roomForm.submit(function(e){
                e.preventDefault();
                var form = this;
                var playerRoom = $('#playerRoomField').val();
                if(playerRoom.length == 4){
                    console.log('trying to join room', playerRoom);
                    playerJoinRoom(playerRoom);
                } else {
                    console.warn('You must enter a room value to enter');
                }
            });

            function showCurtain(value){
                console.log('heard showcurtain with value ' + value + ' and curtain is ' + $curtain);
                if (value)
                    $curtain.show()
                else
                    $curtain.hide();
            }

            // Socket Handling
            socket.on('adminLeft', function(){
                reset();
            });

            // Sets the client's username
            function playerLogin(name) {
                // Tell the server your username
                socket.emit('playerLogin', name);
            }

            function playerJoinRoom(name) {
                socket.emit('playerJoinRoom', name, function(response){
                    if(response.success == true){
                        showMessage("Joined Room", name);
                        $roomEntry.hide();
                    } else {
                        showMessage("Couldn't Join Room", name);
                    }
                });
            }

            socket.on('connect', function(){
                playerLogin(username);
                showMessage("Connected");
            })

            socket.on('disconnect', function(){
                reset();
            })

            function reset() {
                connected = false;
                showCurtain(true);
                $roomEntry.show();
                showMessage('Waiting For Game');
            }

            function showMessage(message){
                $message.html(message);
                console.log(message);
            }

            reset();

        });
